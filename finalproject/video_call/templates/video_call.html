{% extends 'base.html' %}

{% block main %}
  <div class="container mx-auto p-6 bg-white rounded-lg shadow-lg">
    <h2 class="text-2xl font-bold text-center mb-6">Start Video Call</h2>
    <div id="video-container" style="display:none;">
        <video id="local-video" autoplay muted></video>
        <video id="remote-video" autoplay></video>
    </div>

    <div class="text-center mt-6">
        <button id="start-video-call" class="px-6 py-3 bg-green-500 text-white rounded-full hover:bg-green-600">
            Start Video Call
        </button>
    </div>
  </div>

  <script>
    let localStream;
    let peerConnection;
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');

    async function getLocalStream() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = stream;
        localStream = stream;
    }

    function createPeerConnection() {
        const configuration = {
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                }
            ]
        };

        peerConnection = new RTCPeerConnection(configuration);
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = event => {
            remoteVideo.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.send(JSON.stringify({ message: { type: 'ice-candidate', candidate: event.candidate } }));
            }
        };
    }

    async function createOffer() {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.send(JSON.stringify({ message: { type: 'offer', offer: offer } }));
    }

    async function createAnswer() {
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        socket.send(JSON.stringify({ message: { type: 'answer', answer: answer } }));
    }

    document.getElementById("start-video-call").onclick = function() {
        getLocalStream();
        createPeerConnection();
        createOffer();
        document.getElementById("video-container").style.display = "block";
    };
    const roomName = "test_room";  // Set room name dynamically or get it from URL
    const socket = new WebSocket("ws://" + window.location.host + "/ws/video_call/" + roomName + "/");

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.message.type === 'offer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.message.offer));
            createAnswer();
        } else if (data.message.type === 'answer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.message.answer));
        } else if (data.message.type === 'ice-candidate') {
            const candidate = new RTCIceCandidate(data.message.candidate);
            peerConnection.addIceCandidate(candidate);
        }
    };
    function endVideoCall() {
       peerConnection.close();
       peerConnection = null;
       document.getElementById("video-container").style.display = "none";
       document.getElementById("start-video-call").style.display = "block";
    }

  </script>
{% endblock %}
